<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Layout with Layout Dropdown</title>
  <!-- Tailwind CSS Browser Script -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Heroicons for icons: https://heroicons.com -->
  <style>
    /* ===== LAYOUT: GRID BY TWO ===== */
    .layout-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, max-content);
      gap: 1rem; /* Space between pairs/openings */
      justify-content: center;
    }
    /* First page = cover, spans both columns */
    .layout-grid-2 > div:nth-child(1) {
      grid-column: 1 / -1;
      justify-self: center;
    }

    /* ===== LAYOUT: FLEX PAIRS ===== */
    .layout-flex-pairs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem; /* bigger gap between different pairs */
    }
    .layout-flex-pairs > div {
      /* Each page is a "card" in flex mode */
    }
    /* "Pull" odd pages (3,5,7,...) closer to the preceding page (2,4,6,...) */
    .layout-flex-pairs > div:nth-child(odd):not(:first-child) {
      margin-left: -1.6rem; /* negative margin to snug pairs */
    }
  </style>
</head>
<body class="relative min-h-screen bg-gray-200 p-4 flex flex-col items-center justify-start">

  <!-- Original Menu dropdown (for Import/Export only) -->
  <div class="absolute top-4 right-4 flex items-center space-x-2" id="menusContainer">
    <!-- Main MENU for Import/Export -->
    <div class="relative inline-block text-left">
      <button
        id="dropdownToggleBtn"
        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 focus:outline-none"
      >
        <!-- Heroicon: bars-3 -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
             fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <span class="ml-2">Menu</span>
      </button>
      <!-- Dropdown Menu -->
      <div
        id="dropdownMenu"
        class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden"
      >
        <div class="py-1">
          <!-- Export -->
          <button
            id="exportBtn"
            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            <!-- Heroicon: arrow-down-tray (export) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 16.5V18a2.006 2.006 0 0 0 2 2h14a2.006 2.006 0 0 0 2-2v-1.5m-4-2.5-4 4m0 0-4-4m4 4V3"/>
            </svg>
            <span class="ml-2">Export JSON</span>
          </button>

          <!-- Import -->
          <button
            id="importFileBtn"
            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            <!-- Heroicon: arrow-up-tray (import) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 10v1.5a2 2 0 002 2h3m4 4 4-4m0 0-4-4m4 4H10m10 4.5V18a2 2 0 01-2 2h-5" />
            </svg>
            <span class="ml-2">Import File</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden file input for import -->
    <input
      type="file"
      id="fileInput"
      accept="application/json"
      class="hidden"
    />

    <!-- 1) Dropdown for TOTAL RESET -->
    <div class="relative inline-block text-left">
      <button
        id="resetAllToggleBtn"
        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 focus:outline-none"
      >
        <!-- Heroicon: exclamation-triangle -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
             fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M11.049 2.927c.3-.531.81-.927 1.401-.927s1.101.396 1.401.927l7.858 13.896A1.5 1.5 0 0 1 20.858 18H3.142a1.5 1.5 0 0 1-1.351-2.177l7.858-13.896zM12 9v4m0 4h.01" />
        </svg>
        <span class="ml-2">Reset All</span>
      </button>
      <div
        id="resetAllMenu"
        class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden"
      >
        <div class="py-1">
          <button
            id="totalResetBtn"
            class="block w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left"
          >
            Confirm Total Reset
          </button>
        </div>
      </div>
    </div>

    <!-- 2) Dropdown for REMOVING ALL CSS STYLES -->
    <div class="relative inline-block text-left">
      <button
        id="removeStylesToggleBtn"
        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 focus:outline-none"
      >
        <!-- Heroicon: scissors -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
             fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M14.121 14.121a3 3 0 1 0 4.242 4.243M16 8l-6 6m0 0-3 3m3-3l3 3"/>
        </svg>
        <span class="ml-2">Clear CSS</span>
      </button>
      <div
        id="removeStylesMenu"
        class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden"
      >
        <div class="py-1">
          <button
            id="removeStylesBtn"
            class="block w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left"
          >
            Confirm Remove Styles
          </button>
        </div>
      </div>
    </div>

    <!-- 3) Dropdown for REMOVING ALL PAGE TEXT -->
    <div class="relative inline-block text-left">
      <button
        id="removeTextToggleBtn"
        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 focus:outline-none"
      >
        <!-- Heroicon: document-x -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
             fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M9.75 9.75l4.5 4.5m0-4.5-4.5 4.5m.75-8.25h-2a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 8.25 21h7.5A2.25 2.25 0 0 0 18 18.75v-7.5L15.75 6H12" />
        </svg>
        <span class="ml-2">Clear Text</span>
      </button>
      <div
        id="removeTextMenu"
        class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden"
      >
        <div class="py-1">
          <button
            id="removeTextBtn"
            class="block w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left"
          >
            Confirm Remove Text
          </button>
        </div>
      </div>
    </div>

        <!-- NEW LAYOUT DROPDOWN -->
        <div class="relative inline-block text-left">
            <button
              id="layoutToggleBtn"
              class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 focus:outline-none"
            >
              <!-- Heroicon: squares-2x2, for example -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                   fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M3 3h7v7H3zM14 3h7v7h-7zM3 14h7v7H3zM14 14h7v7h-7z" />
              </svg>
              <span class="ml-2">Layout</span>
            </button>
            <div
              id="layoutDropdown"
              class="origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden"
            >
              <div class="py-1">
                <button
                  id="gridLayoutBtn"
                  class="block w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left"
                >
                  Pairs (new lines)
                </button>
                <button
                  id="flexPairsBtn"
                  class="block w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left"
                >
                  Pairs
                </button>
                <button
                  id="noneLayoutBtn"
                  class="block w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left"
                >
                  No Style (default)
                </button>
              </div>
            </div>
          </div>

  </div>

  <!-- Number of pages + generate -->
  <div class="w-full max-w-md flex flex-col sm:flex-row items-center gap-2 mb-4 mt-8">
    <label for="pageInput" class="text-gray-700 font-semibold">Total Pages:</label>
    <input
      type="number"
      id="pageInput"
      class="border border-gray-300 rounded px-2 py-1 w-full sm:w-auto"
      placeholder="e.g. 10"
      min="1"
      value="10"
    />
    <button
      id="generateBtn"
      class="border border-gray-300 rounded px-4 py-1 text-gray-700 hover:bg-gray-100"
    >
      Generate
    </button>
  </div>

  <!-- Insert pages -->
  <div class="w-full max-w-md flex flex-col sm:flex-row items-center gap-2 mb-4">
    <label for="insertAfter" class="text-gray-700 font-semibold">Insert after page #:</label>
    <input
      type="number"
      id="insertAfter"
      class="border border-gray-300 rounded px-2 py-1 w-20"
      value="1"
      min="1"
    />
    <label for="insertCount" class="text-gray-700 font-semibold"># of Pages to Insert:</label>
    <input
      type="number"
      id="insertCount"
      class="border border-gray-300 rounded px-2 py-1 w-20"
      value="1"
      min="1"
    />
    <button
      id="insertPagesBtn"
      class="border border-gray-300 rounded px-4 py-1 text-gray-700 hover:bg-gray-100"
    >
      Insert
    </button>
  </div>

  <!-- Page dimensions -->
  <div class="w-full max-w-md flex flex-col sm:flex-row items-center gap-2 mb-4">
    <label for="pageWidth" class="text-gray-700 font-semibold">Page Width:</label>
    <input
      type="number"
      id="pageWidth"
      class="border border-gray-300 rounded px-2 py-1 w-20"
      value="96"
      min="20"
    />
    <label for="pageHeight" class="text-gray-700 font-semibold">Page Height:</label>
    <input
      type="number"
      id="pageHeight"
      class="border border-gray-300 rounded px-2 py-1 w-20"
      value="128"
      min="20"
    />
  </div>

  <!-- Page styling -->
  <div class="w-full max-w-md flex flex-col gap-2 mb-4">
    <div class="flex flex-col sm:flex-row items-center gap-2">
      <label for="pageNumbers" class="text-gray-700 font-semibold">Page #s (comma-separated):</label>
      <input
        type="text"
        id="pageNumbers"
        class="border border-gray-300 rounded px-2 py-1 w-40"
        placeholder="e.g. 1,3,5"
      />
    </div>

    <div class="flex flex-col sm:flex-row items-center gap-2">
      <label for="customStyle" class="text-gray-700 font-semibold">CSS Style:</label>
      <input
        type="text"
        id="customStyle"
        class="border border-gray-300 rounded px-2 py-1 w-full"
        placeholder="e.g. background: red;"
      />
      <button
        id="applyStyleBtn"
        class="border border-gray-300 rounded px-4 py-1 text-gray-700 hover:bg-gray-100"
      >
        Apply
      </button>
    </div>
  </div>

  <details>
    <summary class="mb-4">Applied styles</summary>
    <div id="stylesList" class="w-full max-w-md mb-4"></div>
  </details>

  <!-- Container for fluid pages -->
  <div id="pagesContainer" class="flex flex-wrap gap-4 w-full justify-center"></div>

  <script>
    // Input references
    const pageInput = document.getElementById('pageInput');
    const pageWidthInput = document.getElementById('pageWidth');
    const pageHeightInput = document.getElementById('pageHeight');
    const pageNumbersInput = document.getElementById('pageNumbers');
    const customStyleInput = document.getElementById('customStyle');
    const generateBtn = document.getElementById('generateBtn');
    const applyStyleBtn = document.getElementById('applyStyleBtn');
    const pagesContainer = document.getElementById('pagesContainer');
    const stylesList = document.getElementById('stylesList');

    // The references for the new layout dropdown
    const layoutToggleBtn = document.getElementById('layoutToggleBtn');
    const layoutDropdown = document.getElementById('layoutDropdown');
    const gridLayoutBtn = document.getElementById('gridLayoutBtn');
    const flexPairsBtn = document.getElementById('flexPairsBtn');
    const noneLayoutBtn = document.getElementById('noneLayoutBtn');

    // Insert references
    const insertAfterInput = document.getElementById('insertAfter');
    const insertCountInput = document.getElementById('insertCount');
    const insertPagesBtn = document.getElementById('insertPagesBtn');

    // Export/Import references
    const exportBtn = document.getElementById('exportBtn');
    const fileInput = document.getElementById('fileInput');
    const importFileBtn = document.getElementById('importFileBtn');

    // Reset button references
    const totalResetBtn = document.getElementById('totalResetBtn');
    const removeStylesBtn = document.getElementById('removeStylesBtn');
    const removeTextBtn = document.getElementById('removeTextBtn');

    // Dropdown toggles
    const dropdownToggleBtn = document.getElementById('dropdownToggleBtn');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const resetAllToggleBtn = document.getElementById('resetAllToggleBtn');
    const resetAllMenu = document.getElementById('resetAllMenu');
    const removeStylesToggleBtn = document.getElementById('removeStylesToggleBtn');
    const removeStylesMenu = document.getElementById('removeStylesMenu');
    const removeTextToggleBtn = document.getElementById('removeTextToggleBtn');
    const removeTextMenu = document.getElementById('removeTextMenu');

    // All input IDs for quick localStorage management
    const inputIds = [
      'pageInput',
      'pageWidth',
      'pageHeight',
      'pageNumbers',
      'customStyle',
    ];

    // We'll store page texts, tooltips, and styles in localStorage.
    let pageTexts = {};      // pageTexts[pageNumber] = 'content'
    let appliedStyles = [];  // array of { id, pages: [1,2], style: 'background: red;' }
    let pageTooltips = {};   // pageTooltips[pageNumber] = 'tooltip text'
    let tooltipPopup = null; // currently open tooltip popup


    // A helper to apply a chosen layout class to #pagesContainer
    function applyLayoutMode(mode) {
      const container = document.getElementById('pagesContainer');
      // Clear all layout classes
      container.classList.remove('layout-grid-2', 'layout-flex-pairs', 'layout-none');
      // Add whichever user selected
      if (mode === 'grid') {
        container.classList.add('layout-grid-2');
      } else if (mode === 'flex') {
        container.classList.add('layout-flex-pairs');
      } else {
        // No style
        container.classList.add('layout-none');
      }
    }

    // Toggle the layout dropdown
    layoutToggleBtn.addEventListener('click', () => {
      layoutDropdown.classList.toggle('hidden');
    });
    // Close if clicking outside
    document.addEventListener('click', (e) => {
      if (!layoutToggleBtn.contains(e.target) && !layoutDropdown.contains(e.target)) {
        layoutDropdown.classList.add('hidden');
      }
    });

    // Hook up each layout button
    gridLayoutBtn.addEventListener('click', () => {
      applyLayoutMode('grid');
      layoutDropdown.classList.add('hidden');
    });
    flexPairsBtn.addEventListener('click', () => {
      applyLayoutMode('flex');
      layoutDropdown.classList.add('hidden');
    });
    noneLayoutBtn.addEventListener('click', () => {
      applyLayoutMode('none');
      layoutDropdown.classList.add('hidden');
    });

    // Load all settings from localStorage or use defaults
    function loadSettingsFromStorage() {
      inputIds.forEach((id) => {
        const savedVal = localStorage.getItem(id);
        if (savedVal !== null) {
          document.getElementById(id).value = savedVal;
        }
      });

      const savedTexts = localStorage.getItem('pageTexts');
      if (savedTexts) {
        pageTexts = JSON.parse(savedTexts);
      }

      const savedStyles = localStorage.getItem('appliedStyles');
      if (savedStyles) {
        appliedStyles = JSON.parse(savedStyles);
      }

      const savedTooltips = localStorage.getItem('pageTooltips');
      if (savedTooltips) {
        pageTooltips = JSON.parse(savedTooltips);
      }
    }

    // Save input changes to localStorage
    function saveSetting(event) {
      localStorage.setItem(event.target.id, event.target.value);
    }

    // Save entire pageTexts object to localStorage
    function savePageTexts() {
      localStorage.setItem('pageTexts', JSON.stringify(pageTexts));
    }

    // Save entire appliedStyles array to localStorage
    function saveAppliedStyles() {
      localStorage.setItem('appliedStyles', JSON.stringify(appliedStyles));
    }

    // Save entire pageTooltips object to localStorage
    function savePageTooltips() {
      localStorage.setItem('pageTooltips', JSON.stringify(pageTooltips));
    }

    // Generate all pages in a fluid layout
    function generatePages() {
      pagesContainer.innerHTML = '';

      let pageCount = parseInt(pageInput.value, 10) || 0;
      // If no pages are set, default to 23 on first load
      if (pageCount < 1) {
        pageCount = 23;
        pageInput.value = 23;
        localStorage.setItem('pageInput', '23');
      }

      const pageWidth = pageWidthInput.value + 'px';
      const pageHeight = pageHeightInput.value + 'px';

      for (let i = 1; i <= pageCount; i++) {
        const pageEl = document.createElement('div');
        pageEl.className =
          'rounded shadow-md flex items-center justify-center font-semibold relative';
        pageEl.style.backgroundColor = 'white';
        pageEl.style.color = '#999';
        pageEl.style.width = pageWidth;
        pageEl.style.height = pageHeight;
        pageEl.dataset.pageNumber = i;
        pageEl.contentEditable = true;

        // Load any saved text
        pageEl.textContent = pageTexts[i] || i.toString();

        // Set native tooltip if available (fallback)
        if (pageTooltips[i]) {
          pageEl.title = pageTooltips[i];

          // Create marker in the corner to indicate a tooltip comment
          const marker = document.createElement('div');
          marker.className = "group absolute top-1 right-1";

          // Small circle marker
          const circle = document.createElement('div');
          circle.className = "w-2 h-2 bg-blue-100 rounded-full cursor-pointer";
          marker.appendChild(circle);

          // Tailwind-styled tooltip
          const tooltip = document.createElement('div');
          tooltip.className =
            "invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-opacity duration-200 absolute right-0 mt-1 px-2 py-1 bg-gray-800 text-white text-xs rounded z-10 whitespace-nowrap";
          tooltip.textContent = pageTooltips[i];
          marker.appendChild(tooltip);

          pageEl.appendChild(marker);
        }

        // Save text changes on-the-fly.
        pageEl.addEventListener('input', () => {
          pageTexts[i] = pageEl.textContent;
          savePageTexts();
        });

        // Add right-click context menu for tooltip editing + delete.
        pageEl.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showContextMenu(pageEl, i, e.clientX, e.clientY);
        });

        pagesContainer.appendChild(pageEl);
      }

      // Re-apply styles.
      applyAllStyles();
    }

    // Apply a single style object across its pages.
    function applyStyleObject(styleObj) {
      styleObj.pages.forEach((p) => {
        const pageEl = pagesContainer.querySelector(`[data-page-number='${p}']`);
        if (pageEl) {
          // Append the new style
          pageEl.style.cssText += styleObj.style;
        }
      });
    }

    // Re-apply all styles from the appliedStyles array.
    function applyAllStyles() {
      appliedStyles.forEach((styleObj) => {
        applyStyleObject(styleObj);
      });
      renderStylesList();
    }

    // Apply new style from user input.
    function applyUserStyle() {
      const styleStr = customStyleInput.value.trim();
      if (!styleStr) return;

      const pageNums = pageNumbersInput.value
        .split(',')
        .map((n) => n.trim())
        .filter((n) => n);
      if (!pageNums.length) return;

      const styleObj = {
        id: Date.now(),
        pages: pageNums,
        style: styleStr,
      };

      appliedStyles.push(styleObj);
      saveAppliedStyles();
      applyStyleObject(styleObj);
      renderStylesList();
    }

    // Remove a previously applied style.
    function removeStyle(styleId) {
      appliedStyles = appliedStyles.filter((s) => s.id !== styleId);
      saveAppliedStyles();
      generatePages(); // regenerates pages + reapplies styles
    }

    // Render list of currently applied styles with edit functionality.
    function renderStylesList() {
      stylesList.innerHTML = '';

      appliedStyles.forEach((styleObj) => {
        const row = document.createElement('div');
        row.className =
          'flex flex-row items-center justify-between mb-2 border-b border-gray-300 pb-2';

        // Create preview square with applied style.
        const previewSquare = document.createElement('div');
        previewSquare.className = 'p-3 mr-2';
        previewSquare.style.cssText = styleObj.style;
        previewSquare.style.border = '1px dashed #999';

        // Show pages & style
        const label = document.createElement('span');
        label.textContent = `Pages: [${styleObj.pages.join(', ')}], Style: "${styleObj.style}"`;
        label.className = 'text-sm';

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remove';
        removeBtn.className = 'text-red-600 hover:text-red-800 ml-4';
        removeBtn.addEventListener('click', () => removeStyle(styleObj.id));

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'text-blue-600 hover:text-blue-800 ml-4';
        editBtn.addEventListener('click', () => {
          // Replace label with input fields for pages & style
          const pagesInputField = document.createElement('input');
          pagesInputField.type = 'text';
          pagesInputField.value = styleObj.pages.join(', ');
          pagesInputField.className = 'border border-gray-300 rounded p-1 w-24';

          const styleInputField = document.createElement('input');
          styleInputField.type = 'text';
          styleInputField.value = styleObj.style;
          styleInputField.className = 'border border-gray-300 rounded p-1 w-40 ml-2';

          // Save / Cancel
          const saveBtn = document.createElement('button');
          saveBtn.textContent = 'Save';
          saveBtn.className = 'text-green-600 hover:text-green-800 ml-4';

          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = 'Cancel';
          cancelBtn.className = 'text-gray-600 hover:text-gray-800 ml-2';

          row.replaceChild(pagesInputField, label);
          row.insertBefore(styleInputField, removeBtn);
          row.insertBefore(saveBtn, removeBtn);
          row.insertBefore(cancelBtn, removeBtn);
          editBtn.style.display = 'none';

          saveBtn.addEventListener('click', () => {
            const newPages = pagesInputField.value
              .split(',')
              .map((x) => x.trim())
              .filter((x) => x);
            const newStyle = styleInputField.value.trim();
            if (newPages.length && newStyle) {
              styleObj.pages = newPages;
              styleObj.style = newStyle;
              saveAppliedStyles();
              generatePages();
            }
          });
          cancelBtn.addEventListener('click', () => {
            renderStylesList();
          });
        });

        row.appendChild(previewSquare);
        row.appendChild(label);
        row.appendChild(editBtn);
        row.appendChild(removeBtn);
        stylesList.appendChild(row);
      });
    }

    // Right-click menu for tooltip & delete page
    function showContextMenu(pageEl, pageNumber, x, y) {
      // Remove existing popup if any
      if (tooltipPopup) {
        tooltipPopup.remove();
      }

      tooltipPopup = document.createElement('div');
      tooltipPopup.className = 'absolute bg-white border border-gray-300 p-2 rounded shadow-lg';
      tooltipPopup.style.left = x + 'px';
      tooltipPopup.style.top = y + 'px';
      tooltipPopup.style.zIndex = 1000;

      // Tooltip input
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Enter tooltip text';
      input.className = 'border border-gray-300 rounded p-1 mr-2 mb-2 w-full';
      if (pageTooltips[pageNumber]) {
        input.value = pageTooltips[pageNumber];
      }

      // Save tooltip button
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save Tooltip';
      saveBtn.className = 'border border-gray-300 bg-white text-gray-700 px-2 py-1 rounded mr-2 mb-2 hover:bg-gray-100';
      saveBtn.addEventListener('click', () => {
        const tooltipText = input.value.trim();
        pageTooltips[pageNumber] = tooltipText;
        pageEl.title = tooltipText; // fallback
        savePageTooltips();
        closeContextMenu();
        generatePages();
      });

      // Delete page button
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete Page';
      deleteBtn.className = 'border border-gray-300 bg-white text-gray-700 px-2 py-1 rounded mr-2 mb-2 hover:bg-gray-100';
      deleteBtn.addEventListener('click', () => {
        deletePage(pageNumber);
        closeContextMenu();
      });

      // Cancel button
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'border border-gray-300 bg-white text-gray-700 px-2 py-1 rounded mb-2 hover:bg-gray-100';
      cancelBtn.addEventListener('click', closeContextMenu);

      tooltipPopup.appendChild(input);
      tooltipPopup.appendChild(saveBtn);
      tooltipPopup.appendChild(deleteBtn);
      tooltipPopup.appendChild(cancelBtn);
      document.body.appendChild(tooltipPopup);

      // Close if clicking outside
      setTimeout(() => {
        document.addEventListener('click', onClickOutside);
      }, 0);

      function onClickOutside(e) {
        if (tooltipPopup && !tooltipPopup.contains(e.target)) {
          closeContextMenu();
        }
      }
      function closeContextMenu() {
        if (tooltipPopup) {
          tooltipPopup.remove();
          tooltipPopup = null;
          document.removeEventListener('click', onClickOutside);
        }
      }
    }

    // Delete a page from the layout
    function deletePage(pageNumber) {
      const currentCount = parseInt(pageInput.value, 10) || 0;
      if (currentCount <= 1) {
        // If there's only one page, we clear it
        pageInput.value = 0;
        pageTexts = {};
        pageTooltips = {};
        savePageTexts();
        savePageTooltips();
        generatePages();
        return;
      }
      // Shift pages i+1..N => i..(N-1)
      for (let i = pageNumber; i < currentCount; i++) {
        pageTexts[i] = pageTexts[i + 1] || '';
        pageTooltips[i] = pageTooltips[i + 1] || '';
      }
      delete pageTexts[currentCount];
      delete pageTooltips[currentCount];

      // Adjust styles referencing pages > pageNumber
      appliedStyles.forEach((sObj) => {
        sObj.pages = sObj.pages.reduce((arr, p) => {
          const numP = parseInt(p, 10);
          if (numP === pageNumber) {
            // skip
          } else if (numP > pageNumber) {
            arr.push((numP - 1).toString());
          } else {
            arr.push(p);
          }
          return arr;
        }, []);
      });

      // Decrement total page count
      pageInput.value = currentCount - 1;

      // Save updates
      savePageTexts();
      savePageTooltips();
      saveAppliedStyles();
      generatePages();
    }

    // Insert pages after a specific page
    function insertPages() {
      const after = parseInt(insertAfterInput.value, 10);
      const count = parseInt(insertCountInput.value, 10);
      const currentCount = parseInt(pageInput.value, 10) || 0;
      if (count < 1) return;
      if (after < 1 || after > currentCount) return;

      // Move old pages up
      for (let i = currentCount; i > after; i--) {
        pageTexts[i + count] = pageTexts[i] || '';
        pageTooltips[i + count] = pageTooltips[i] || '';
        delete pageTexts[i];
        delete pageTooltips[i];
      }

      // Clear the newly inserted pages
      for (let i = 1; i <= count; i++) {
        const newIndex = after + i;
        pageTexts[newIndex] = '';
        pageTooltips[newIndex] = '';
      }

      // Adjust styles referencing pages > after
      appliedStyles.forEach((sObj) => {
        sObj.pages = sObj.pages.map((p) => {
          const numP = parseInt(p, 10);
          return (numP > after) ? (numP + count).toString() : p;
        });
      });

      // Increase total page count
      pageInput.value = currentCount + count;

      // Save updates
      savePageTexts();
      savePageTooltips();
      saveAppliedStyles();

      generatePages();
    }

    // Export all data as JSON and download it
    function exportData() {
      const data = {
        pageCount: pageInput.value,
        pageTexts,
        appliedStyles,
        pageTooltips,
      };
      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'bookLayout.json';
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Import from JSON file
    function onFileSelected(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const raw = evt.target.result;
          const parsed = JSON.parse(raw);
          // Overwrite local data
          if (typeof parsed.pageCount !== 'undefined') {
            pageInput.value = parsed.pageCount;
          }
          if (parsed.pageTexts) {
            pageTexts = parsed.pageTexts;
          }
          if (parsed.appliedStyles) {
            appliedStyles = parsed.appliedStyles;
          }
          if (parsed.pageTooltips) {
            pageTooltips = parsed.pageTooltips;
          }
          // Save everything
          inputIds.forEach((id) => {
            localStorage.setItem(id, document.getElementById(id).value);
          });
          savePageTexts();
          savePageTooltips();
          saveAppliedStyles();
          // Re-generate
          generatePages();
        } catch (err) {
          alert('Invalid JSON data in the selected file!');
        }
      };
      reader.readAsText(file);
    }

    // Handle toggles for each dropdown
    function setupDropdown(toggleBtn, dropdownEl) {
      toggleBtn.addEventListener('click', () => {
        dropdownEl.classList.toggle('hidden');
      });
      // Close if clicked outside
      document.addEventListener('click', (e) => {
        if (!toggleBtn.contains(e.target) && !dropdownEl.contains(e.target)) {
          dropdownEl.classList.add('hidden');
        }
      });
    }

    // -- DOM Loaded --
    document.addEventListener('DOMContentLoaded', () => {
      // 1) Load from localStorage
      loadSettingsFromStorage();

      // 2) Setup watchers
      inputIds.forEach((id) => {
        document.getElementById(id).addEventListener('input', saveSetting);
      });

      // 3) Initialize pages
      generatePages();

      // 4) Button listeners
      generateBtn.addEventListener('click', generatePages);
      applyStyleBtn.addEventListener('click', applyUserStyle);
      insertPagesBtn.addEventListener('click', insertPages);
      exportBtn.addEventListener('click', exportData);
      importFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', onFileSelected);

      // 5) Setup the reset actions
      totalResetBtn.addEventListener('click', () => {
        if (!confirm('This will clear ALL data (pages, styles, text, tooltips). Proceed?')) return;
        // Clear relevant localStorage keys
        inputIds.forEach((id) => localStorage.removeItem(id));
        localStorage.removeItem('pageTexts');
        localStorage.removeItem('pageTooltips');
        localStorage.removeItem('appliedStyles');
        // Clear in-memory data
        pageTexts = {};
        appliedStyles = [];
        pageTooltips = {};
        // Reset page count to 0 => becomes 23 after generate
        pageInput.value = 0;
        generatePages();
        resetAllMenu.classList.add('hidden');
      });
      removeStylesBtn.addEventListener('click', () => {
        if (!confirm('Remove all applied CSS styles?')) return;
        localStorage.removeItem('appliedStyles');
        appliedStyles = [];
        generatePages();
        removeStylesMenu.classList.add('hidden');
      });
      removeTextBtn.addEventListener('click', () => {
        if (!confirm('Remove all custom text from pages (keeping tooltips)?')) return;
        Object.keys(pageTexts).forEach((k) => {
          pageTexts[k] = '';
        });
        savePageTexts();
        generatePages();
        removeTextMenu.classList.add('hidden');
      });

      // 6) Setup each dropdown’s toggle
      //    (Main Menu)
      dropdownToggleBtn.addEventListener('click', () => {
        dropdownMenu.classList.toggle('hidden');
      });
      document.addEventListener('click', (e) => {
        const container = document.getElementById('menusContainer');
        if (!container.contains(e.target)) {
          dropdownMenu.classList.add('hidden');
        }
      });

      //   (Reset All)
      setupDropdown(resetAllToggleBtn, resetAllMenu);
      //   (Remove Styles)
      setupDropdown(removeStylesToggleBtn, removeStylesMenu);
      //   (Remove Text)
      setupDropdown(removeTextToggleBtn, removeTextMenu);
    });
  </script>
</body>
</html>
