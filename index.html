<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enhanced Book Layout (Dropdown Import/Export)</title>
  <!-- Tailwind CSS Browser Script -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- We'll use Heroicons for import/export icons: https://heroicons.com -->
</head>
<body class="relative min-h-screen bg-gray-200 p-4 flex flex-col items-center justify-start">

  <!-- Dropdown in the top-right corner for Export/Import -->
  <div class="absolute top-4 right-4" id="exportImportDropdownContainer">
    <div class="relative inline-block text-left">
      <button
        id="dropdownToggleBtn"
        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 focus:outline-none"
      >
        <!-- Heroicon: bars-3 -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <span class="ml-2">Menu</span>
      </button>

      <!-- Dropdown Menu -->
      <div
        id="dropdownMenu"
        class="origin-top-right absolute right-0 mt-2 w-44 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden"
      >
        <div class="py-1">
          <button
            id="exportBtn"
            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            <!-- Heroicon: arrow-down-tray (export) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5V18a2.006 2.006 0 0 0 2 2h14a2.006 2.006 0 0 0 2-2v-1.5m-4-2.5-4 4m0 0-4-4m4 4V3"/>
            </svg>
            <span class="ml-2">Export JSON</span>
          </button>
          <button
            id="importFileBtn"
            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            <!-- Heroicon: arrow-up-tray (import) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 10v1.5a2 2 0 002 2h3m4 4 4-4m0 0-4-4m4 4H10m10 4.5V18a2 2 0 01-2 2h-5" />
            </svg>
            <span class="ml-2">Import File</span>
          </button>
        </div>
      </div>
    </div>
    <!-- Hidden file input for import -->
    <input
      type="file"
      id="fileInput"
      accept="application/json"
      class="hidden"
    />
  </div>

  <!-- Number of pages + generate -->
  <div class="w-full max-w-md flex flex-col sm:flex-row items-center gap-2 mb-4 mt-8">
    <label for="pageInput" class="text-gray-700 font-semibold">Total Pages:</label>
    <input
      type="number"
      id="pageInput"
      class="border border-gray-300 rounded px-2 py-1 w-full sm:w-auto"
      placeholder="e.g. 10"
      min="1"
      value="10"
    />
    <button
      id="generateBtn"
      class="border border-gray-300 rounded px-4 py-1 text-gray-700 hover:bg-gray-100"
    >
      Generate
    </button>
  </div>

  <!-- Insert pages -->
  <div class="w-full max-w-md flex flex-col sm:flex-row items-center gap-2 mb-4">
    <label for="insertAfter" class="text-gray-700 font-semibold">Insert after page #:</label>
    <input
      type="number"
      id="insertAfter"
      class="border border-gray-300 rounded px-2 py-1 w-20"
      value="1"
      min="1"
    />
    <label for="insertCount" class="text-gray-700 font-semibold"># of Pages to Insert:</label>
    <input
      type="number"
      id="insertCount"
      class="border border-gray-300 rounded px-2 py-1 w-20"
      value="1"
      min="1"
    />
    <button
      id="insertPagesBtn"
      class="border border-gray-300 rounded px-4 py-1 text-gray-700 hover:bg-gray-100"
    >
      Insert
    </button>
  </div>

  <!-- Page dimensions -->
  <div class="w-full max-w-md flex flex-col sm:flex-row items-center gap-2 mb-4">
    <label for="pageWidth" class="text-gray-700 font-semibold">Page Width:</label>
    <input
      type="number"
      id="pageWidth"
      class="border border-gray-300 rounded px-2 py-1 w-20"
      value="96"
      min="20"
    />
    <label for="pageHeight" class="text-gray-700 font-semibold">Page Height:</label>
    <input
      type="number"
      id="pageHeight"
      class="border border-gray-300 rounded px-2 py-1 w-20"
      value="128"
      min="20"
    />
  </div>

  <!-- Page styling -->
  <div class="w-full max-w-md flex flex-col gap-2 mb-4">
    <div class="flex flex-col sm:flex-row items-center gap-2">
      <label for="pageNumbers" class="text-gray-700 font-semibold">Page #s (comma-separated):</label>
      <input
        type="text"
        id="pageNumbers"
        class="border border-gray-300 rounded px-2 py-1 w-40"
        placeholder="e.g. 1,3,5"
      />
    </div>

    <div class="flex flex-col sm:flex-row items-center gap-2">
      <label for="customStyle" class="text-gray-700 font-semibold">CSS Style:</label>
      <input
        type="text"
        id="customStyle"
        class="border border-gray-300 rounded px-2 py-1 w-full"
        placeholder="e.g. background: red;"
      />
      <button
        id="applyStyleBtn"
        class="border border-gray-300 rounded px-4 py-1 text-gray-700 hover:bg-gray-100"
      >
        Apply
      </button>
    </div>
  </div>

  <details>
    <summary class="mb-4">Applied styles</summary>
    <div id="stylesList" class="w-full max-w-md mb-4"></div>
  </details>

  <!-- Container for fluid pages -->
  <div id="pagesContainer" class="flex flex-wrap gap-4 w-full justify-center"></div>

  <script>
    // Input references
    const pageInput = document.getElementById('pageInput');
    const pageWidthInput = document.getElementById('pageWidth');
    const pageHeightInput = document.getElementById('pageHeight');
    const pageNumbersInput = document.getElementById('pageNumbers');
    const customStyleInput = document.getElementById('customStyle');
    const generateBtn = document.getElementById('generateBtn');
    const applyStyleBtn = document.getElementById('applyStyleBtn');
    const pagesContainer = document.getElementById('pagesContainer');
    const stylesList = document.getElementById('stylesList');

    // Insert references
    const insertAfterInput = document.getElementById('insertAfter');
    const insertCountInput = document.getElementById('insertCount');
    const insertPagesBtn = document.getElementById('insertPagesBtn');

    // Export / Import references
    const exportBtn = document.getElementById('exportBtn');
    const fileInput = document.getElementById('fileInput');
    const importFileBtn = document.getElementById('importFileBtn');

    // Dropdown references
    const dropdownToggleBtn = document.getElementById('dropdownToggleBtn');
    const dropdownMenu = document.getElementById('dropdownMenu');

    // All input IDs for quick localStorage management
    const inputIds = [
      'pageInput',
      'pageWidth',
      'pageHeight',
      'pageNumbers',
      'customStyle',
    ];

    // We'll store page texts, tooltips, and styles in localStorage.
    let pageTexts = {};      // pageTexts[pageNumber] = 'content'
    let appliedStyles = [];  // array of { id, pages: [1,2], style: 'background: red;' }
    let pageTooltips = {};   // pageTooltips[pageNumber] = 'tooltip text'
    let tooltipPopup = null; // currently open tooltip popup

    // Load all settings from localStorage or use defaults
    function loadSettingsFromStorage() {
      inputIds.forEach((id) => {
        const savedVal = localStorage.getItem(id);
        if (savedVal !== null) {
          document.getElementById(id).value = savedVal;
        }
      });

      const savedTexts = localStorage.getItem('pageTexts');
      if (savedTexts) {
        pageTexts = JSON.parse(savedTexts);
      }

      const savedStyles = localStorage.getItem('appliedStyles');
      if (savedStyles) {
        appliedStyles = JSON.parse(savedStyles);
      }

      const savedTooltips = localStorage.getItem('pageTooltips');
      if (savedTooltips) {
        pageTooltips = JSON.parse(savedTooltips);
      }
    }

    // Save input changes to localStorage
    function saveSetting(event) {
      localStorage.setItem(event.target.id, event.target.value);
    }

    // Save entire pageTexts object to localStorage
    function savePageTexts() {
      localStorage.setItem('pageTexts', JSON.stringify(pageTexts));
    }

    // Save entire appliedStyles array to localStorage
    function saveAppliedStyles() {
      localStorage.setItem('appliedStyles', JSON.stringify(appliedStyles));
    }

    // Save entire pageTooltips object to localStorage
    function savePageTooltips() {
      localStorage.setItem('pageTooltips', JSON.stringify(pageTooltips));
    }

    // Generate all pages in a fluid layout
    function generatePages() {
      pagesContainer.innerHTML = '';

      const pageCount = parseInt(pageInput.value, 10) || 0;
      const pageWidth = pageWidthInput.value + 'px';
      const pageHeight = pageHeightInput.value + 'px';

      for (let i = 1; i <= pageCount; i++) {
        const pageEl = document.createElement('div');
        pageEl.className =
          'rounded shadow-md flex items-center justify-center font-semibold relative';
        pageEl.style.backgroundColor = 'white'; // default color
        pageEl.style.color = '#999'; // default color
        pageEl.style.width = pageWidth;
        pageEl.style.height = pageHeight;
        pageEl.dataset.pageNumber = i;
        pageEl.contentEditable = true;
        // If we have saved text, load it
        pageEl.textContent = pageTexts[i] || i.toString();

        // Set native tooltip if available (fallback)
        if (pageTooltips[i]) {
          pageEl.title = pageTooltips[i];

          // Create marker in the corner to indicate a tooltip comment.
          const marker = document.createElement('div');
          marker.className = "group absolute top-1 right-1";

          // Small circle marker.
          const circle = document.createElement('div');
          circle.className = "w-3 h-3 bg-blue-500 rounded-full cursor-pointer";
          marker.appendChild(circle);

          // Tailwind-styled tooltip. Initially invisible; shows on hover.
          const tooltip = document.createElement('div');
          tooltip.className = "invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-opacity duration-200 absolute right-0 mt-1 px-2 py-1 bg-gray-800 text-white text-xs rounded z-10 whitespace-nowrap";
          tooltip.textContent = pageTooltips[i];
          marker.appendChild(tooltip);

          pageEl.appendChild(marker);
        }

        // Save text changes on-the-fly.
        pageEl.addEventListener('input', () => {
          pageTexts[i] = pageEl.textContent;
          savePageTexts();
        });

        // Add right-click context menu for tooltip editing + delete.
        pageEl.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showContextMenu(pageEl, i, e.clientX, e.clientY);
        });

        pagesContainer.appendChild(pageEl);
      }

      // Re-apply styles.
      applyAllStyles();
    }

    // Apply a single style object across its pages.
    function applyStyleObject(styleObj) {
      styleObj.pages.forEach((p) => {
        const pageEl = pagesContainer.querySelector(`[data-page-number='${p}']`);
        if (pageEl) {
          // Append the new style to existing styles.
          pageEl.style.cssText += styleObj.style;
        }
      });
    }

    // Re-apply all styles from the appliedStyles array.
    function applyAllStyles() {
      appliedStyles.forEach((styleObj) => {
        applyStyleObject(styleObj);
      });
      renderStylesList();
    }

    // Apply new style from user input.
    function applyUserStyle() {
      const styleStr = customStyleInput.value.trim();
      if (!styleStr) return;

      const pageNums = pageNumbersInput.value
        .split(',')
        .map((n) => n.trim())
        .filter((n) => n);
      if (!pageNums.length) return;

      const styleObj = {
        id: Date.now(),
        pages: pageNums,
        style: styleStr,
      };

      appliedStyles.push(styleObj);
      saveAppliedStyles();
      applyStyleObject(styleObj);
      renderStylesList();
    }

    // Remove a previously applied style.
    function removeStyle(styleId) {
      appliedStyles = appliedStyles.filter((s) => s.id !== styleId);
      saveAppliedStyles();
      generatePages(); // regenerates pages and reapplies styles.
    }

    // Render list of currently applied styles with edit functionality.
    function renderStylesList() {
      stylesList.innerHTML = '';

      appliedStyles.forEach((styleObj) => {
        const row = document.createElement('div');
        row.className =
          'flex flex-row items-center justify-between mb-2 border-b border-gray-300 pb-2';

        // Create preview square with applied style.
        const previewSquare = document.createElement('div');
        previewSquare.className = 'p-3 mr-2';
        previewSquare.style.cssText = styleObj.style;
        previewSquare.style.border = '1px dashed #999';

        // Create a span to show the current pages and style.
        const label = document.createElement('span');
        label.textContent = `Pages: [${styleObj.pages.join(', ')}], Style: "${styleObj.style}"`;
        label.className = 'text-sm';

        // Create Remove button.
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remove';
        removeBtn.className = 'text-red-600 hover:text-red-800 ml-4';
        removeBtn.addEventListener('click', () => removeStyle(styleObj.id));

        // Create Edit button.
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'text-blue-600 hover:text-blue-800 ml-4';
        editBtn.addEventListener('click', () => {
          // Replace the label with input fields for pages and style.
          const pagesInputField = document.createElement('input');
          pagesInputField.type = 'text';
          pagesInputField.value = styleObj.pages.join(', ');
          pagesInputField.className =
            'border border-gray-300 rounded p-1 w-24';

          const styleInputField = document.createElement('input');
          styleInputField.type = 'text';
          styleInputField.value = styleObj.style;
          styleInputField.className =
            'border border-gray-300 rounded p-1 w-40 ml-2';

          // Create Save and Cancel buttons for the inline edit.
          const saveBtn = document.createElement('button');
          saveBtn.textContent = 'Save';
          saveBtn.className = 'text-green-600 hover:text-green-800 ml-4';

          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = 'Cancel';
          cancelBtn.className = 'text-gray-600 hover:text-gray-800 ml-2';

          // Hide the original label and edit button.
          row.replaceChild(pagesInputField, label);
          row.insertBefore(styleInputField, removeBtn);
          row.insertBefore(saveBtn, removeBtn);
          row.insertBefore(cancelBtn, removeBtn);
          editBtn.style.display = 'none';

          // On Save, update the style object and reapply styles.
          saveBtn.addEventListener('click', () => {
            const newPages = pagesInputField.value
              .split(',')
              .map((x) => x.trim())
              .filter((x) => x !== '');
            const newStyle = styleInputField.value.trim();
            if (newPages.length && newStyle) {
              styleObj.pages = newPages;
              styleObj.style = newStyle;
              saveAppliedStyles();
              generatePages();
            }
          });

          // On Cancel, re-render the styles list to cancel editing.
          cancelBtn.addEventListener('click', () => {
            renderStylesList();
          });
        });

        row.appendChild(previewSquare);
        row.appendChild(label);
        row.appendChild(editBtn);
        row.appendChild(removeBtn);
        stylesList.appendChild(row);
      });
    }

    // Show a context menu (tooltip + delete page) on right-click on a page.
    function showContextMenu(pageEl, pageNumber, x, y) {
      // Remove existing popup if any.
      if (tooltipPopup) {
        tooltipPopup.remove();
      }

      tooltipPopup = document.createElement('div');
      tooltipPopup.className = 'absolute bg-white border border-gray-300 p-2 rounded shadow-lg';
      tooltipPopup.style.left = x + 'px';
      tooltipPopup.style.top = y + 'px';
      tooltipPopup.style.zIndex = 1000;

      // Tooltip input
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Enter tooltip text';
      input.className = 'border border-gray-300 rounded p-1 mr-2 mb-2 w-full';
      if (pageTooltips[pageNumber]) {
        input.value = pageTooltips[pageNumber];
      }

      // Save tooltip button
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save Tooltip';
      saveBtn.className = 'border border-gray-300 bg-white text-gray-700 px-2 py-1 rounded mr-2 mb-2 hover:bg-gray-100';
      saveBtn.addEventListener('click', () => {
        const tooltipText = input.value.trim();
        pageTooltips[pageNumber] = tooltipText;
        // Also update the native title (for fallback).
        pageEl.title = tooltipText;
        savePageTooltips();
        closeContextMenu();
        // Regenerate pages to show or update the marker.
        generatePages();
      });

      // Delete page button
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete Page';
      deleteBtn.className = 'border border-gray-300 bg-white text-gray-700 px-2 py-1 rounded mr-2 mb-2 hover:bg-gray-100';
      deleteBtn.addEventListener('click', () => {
        deletePage(pageNumber);
        closeContextMenu();
      });

      // Cancel button
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'border border-gray-300 bg-white text-gray-700 px-2 py-1 rounded mb-2 hover:bg-gray-100';
      cancelBtn.addEventListener('click', () => {
        closeContextMenu();
      });

      tooltipPopup.appendChild(input);
      tooltipPopup.appendChild(saveBtn);
      tooltipPopup.appendChild(deleteBtn);
      tooltipPopup.appendChild(cancelBtn);
      document.body.appendChild(tooltipPopup);

      // Close if clicking outside
      setTimeout(() => {
        document.addEventListener('click', onClickOutside);
      }, 0);

      function onClickOutside(e) {
        if (tooltipPopup && !tooltipPopup.contains(e.target)) {
          closeContextMenu();
        }
      }

      function closeContextMenu() {
        if (tooltipPopup) {
          tooltipPopup.remove();
          tooltipPopup = null;
          document.removeEventListener('click', onClickOutside);
        }
      }
    }

    // Delete a page from the layout.
    function deletePage(pageNumber) {
      const currentCount = parseInt(pageInput.value, 10) || 0;
      if (currentCount <= 1) {
        // If there's only one page left, let's just clear it.
        pageInput.value = 0;
        pageTexts = {};
        pageTooltips = {};
        localStorage.setItem('pageTexts', JSON.stringify(pageTexts));
        localStorage.setItem('pageTooltips', JSON.stringify(pageTooltips));
        generatePages();
        return;
      }

      // Deleting page i means shifting pages i+1..N => i..(N-1)
      for (let i = pageNumber; i < currentCount; i++) {
        pageTexts[i] = pageTexts[i + 1] || '';
        pageTooltips[i] = pageTooltips[i + 1] || '';
      }
      delete pageTexts[currentCount];
      delete pageTooltips[currentCount];

      // Adjust styles that reference pages above pageNumber
      appliedStyles.forEach((sObj) => {
        sObj.pages = sObj.pages.reduce((arr, p) => {
          const numP = parseInt(p, 10);
          if (numP === pageNumber) {
            // omit the page we removed
          } else if (numP > pageNumber) {
            arr.push((numP - 1).toString());
          } else {
            arr.push(p);
          }
          return arr;
        }, []);
      });

      // Decrement total page count
      pageInput.value = currentCount - 1;

      // Save updates
      savePageTexts();
      savePageTooltips();
      saveAppliedStyles();
      // Regenerate
      generatePages();
    }

    // Insert pages after a specific page.
    function insertPages() {
      const after = parseInt(insertAfterInput.value, 10);
      const count = parseInt(insertCountInput.value, 10);
      const currentCount = parseInt(pageInput.value, 10) || 0;
      if (count < 1) return;
      if (after < 1 || after > currentCount) return;

      // Example: Insert X pages after Y. Then page Y+1..N => Y+X+1..N+X
      for (let i = currentCount; i > after; i--) {
        pageTexts[i + count] = pageTexts[i] || '';
        pageTooltips[i + count] = pageTooltips[i] || '';
        delete pageTexts[i];
        delete pageTooltips[i];
      }

      // Clear the newly inserted pages (Y+1..Y+X)
      for (let i = 1; i <= count; i++) {
        const newPageIndex = after + i;
        pageTexts[newPageIndex] = '';
        pageTooltips[newPageIndex] = '';
      }

      // Adjust styles that reference pages above 'after'
      appliedStyles.forEach((sObj) => {
        sObj.pages = sObj.pages.map((p) => {
          const numP = parseInt(p, 10);
          if (numP > after) {
            return (numP + count).toString();
          } else {
            return p;
          }
        });
      });

      // Increase total page count
      pageInput.value = currentCount + count;

      // Save updates
      savePageTexts();
      savePageTooltips();
      saveAppliedStyles();

      // Regenerate
      generatePages();
    }

    // Export all data as JSON and download it.
    function exportData() {
      const data = {
        pageCount: pageInput.value,
        pageTexts: pageTexts,
        appliedStyles: appliedStyles,
        pageTooltips: pageTooltips,
      };

      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'bookLayout.json';

      document.body.appendChild(a);
      a.click();

      // Cleanup
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Import from JSON file.
    function onFileSelected(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const raw = e.target.result;
          const parsed = JSON.parse(raw);
          // Overwrite local data.
          if (typeof parsed.pageCount !== 'undefined') {
            pageInput.value = parsed.pageCount;
          }
          if (parsed.pageTexts) {
            pageTexts = parsed.pageTexts;
          }
          if (parsed.appliedStyles) {
            appliedStyles = parsed.appliedStyles;
          }
          if (parsed.pageTooltips) {
            pageTooltips = parsed.pageTooltips;
          }

          // Save everything.
          inputIds.forEach((id) => {
            localStorage.setItem(id, document.getElementById(id).value);
          });
          savePageTexts();
          savePageTooltips();
          saveAppliedStyles();

          // Re-generate.
          generatePages();
        } catch (err) {
          alert('Invalid JSON data in the selected file!');
        }
      };
      reader.readAsText(file);
    }

    // Toggle the dropdown menu
    dropdownToggleBtn.addEventListener('click', () => {
      dropdownMenu.classList.toggle('hidden');
    });

    // Close the dropdown if clicked outside
    document.addEventListener('click', (e) => {
      if (!document.getElementById('exportImportDropdownContainer').contains(e.target)) {
        dropdownMenu.classList.add('hidden');
      }
    });

    // Initialization on DOM load.
    document.addEventListener('DOMContentLoaded', () => {
      // Load from localStorage.
      loadSettingsFromStorage();

      // Add input listeners to store new values in localStorage.
      inputIds.forEach((id) => {
        document.getElementById(id).addEventListener('input', saveSetting);
      });

      // Generate pages initially.
      generatePages();

      // Button listeners.
      generateBtn.addEventListener('click', generatePages);
      applyStyleBtn.addEventListener('click', applyUserStyle);
      insertPagesBtn.addEventListener('click', insertPages);
      exportBtn.addEventListener('click', exportData);
      importFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', onFileSelected);
    });
  </script>
</body>
</html>
